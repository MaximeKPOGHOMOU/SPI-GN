<div class="affectations-container">

  <!-- Card Header avec recherche -->
  <div class="card-header">
    <h3>GESTION DES AFFECTATIONS</h3>
    <div class="header-actions">
      <mat-form-field appearance="fill" class="search-field">
        <mat-label>Rechercher...</mat-label>
        <input matInput (keyup)="applyFilter($event)" placeholder="Agent, Site…">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>
  </div>

  <!-- Toolbar avec titre et bouton ajouter -->
  <mat-toolbar color="primary" class="center-toolbar page-title">
    <span>LISTE DES AFFECTATIONS</span>
    <span class="toolbar-spacer"></span>
    <button mat-raised-button class="btn-red" (click)="openAddAffectationDialog()">
      <mat-icon>assignment_ind</mat-icon>
      Ajouter
    </button>
  </mat-toolbar>

  <!-- Card -->
  <mat-card>

    <!-- Spinner -->
    <div *ngIf="loading" class="spinner-container">
      <mat-spinner [diameter]="50"></mat-spinner>
    </div>

    <!-- Table wrapper avec scroll horizontal -->
    <div class="table-wrapper" *ngIf="!loading && affectations.data.length > 0">
      <table mat-table [dataSource]="affectations" class="mat-elevation-z8 full-table">

        <!-- N° -->
        <ng-container matColumnDef="index">
          <th mat-header-cell *matHeaderCellDef>N°</th>
          <td mat-cell *matCellDef="let a; let i = index">{{ i + 1 }}</td>
        </ng-container>

        <!-- Agent -->
        <ng-container matColumnDef="agent">
          <th mat-header-cell *matHeaderCellDef>AGENT</th>
          <td mat-cell *matCellDef="let a">{{ a.agent?.first_name + ' ' + a.agent?.last_name || a.agent_name }}</td>
        </ng-container>

        <!-- Site -->
        <ng-container matColumnDef="site">
          <th mat-header-cell *matHeaderCellDef>SITE</th>
          <td mat-cell *matCellDef="let a">{{ a.site?.name || a.site_name }}</td>
        </ng-container>

        <!-- Date début -->
        <ng-container matColumnDef="date_debut">
          <th mat-header-cell *matHeaderCellDef>DATE DÉBUT</th>
          <td mat-cell *matCellDef="let a">{{ a.date_debut | date:'dd/MM/yyyy' }}</td>
        </ng-container>

        <!-- Date fin -->
        <ng-container matColumnDef="date_fin">
          <th mat-header-cell *matHeaderCellDef>DATE FIN</th>
          <td mat-cell *matCellDef="let a">{{ a.date_fin ? (a.date_fin | date:'dd/MM/yyyy') : '-' }}</td>
        </ng-container>

        <!-- Jours effectués -->
        <ng-container matColumnDef="nb_jours">
          <th mat-header-cell *matHeaderCellDef>JOURS EFFECTUÉS</th>
          <td mat-cell *matCellDef="let a">{{ a.nb_jours || '-' }}</td>
        </ng-container>

        <!-- Status -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>STATUS</th>
          <td mat-cell *matCellDef="let a">
            <span [style.color]="getStatus(a).color" style="font-weight: bold">
              {{ getStatus(a).text }}
            </span>
          </td>
        </ng-container>

        <!-- Type service -->
        <ng-container matColumnDef="type_service">
          <th mat-header-cell *matHeaderCellDef>TYPE SERVICE</th>
          <td mat-cell *matCellDef="let a">{{ a.type_service || '-' }}</td>
        </ng-container>

        <!-- Type affectation -->
        <ng-container matColumnDef="type_affectation">
          <th mat-header-cell *matHeaderCellDef>TYPE AFFECTATION</th>
          <td mat-cell *matCellDef="let a">{{ a.type_affectation || '-' }}</td>
        </ng-container>

        <!-- Actions -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>ACTIONS</th>
          <td mat-cell *matCellDef="let a" class="mat-column-actions">
            <button mat-icon-button color="primary" (click)="openStopAffectationDialog(a)">
              <mat-icon>stop_circle</mat-icon>
            </button>
            <button mat-icon-button color="primary" (click)="openEditAffectationDialog(a)">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="primary">
              <mat-icon>visibility</mat-icon>
            </button>
          </td>
        </ng-container>

        <!-- Header et rows -->
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

      </table>
    </div>

    <!-- Message "aucune donnée" -->
    <div *ngIf="!loading && affectations.data.length === 0" class="no-data-message">
      Aucune affectation disponible.
    </div>

  </mat-card>

</div>
